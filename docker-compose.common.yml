version: "3.8"

#####
# ‚≠êÔ∏è This file is not independent :
## üü¢ Docker-compose DEV mode, starts with
# $ docker-compose [build|up -d|down] -f docker-compose.common.yml -f docker-compose.dev.yml
# OR
# $ docker-compose config docker-compose.common.yml -f docker-compose.dev.yml > docker-compose.yml
# $ docker-compose [build|up -d|down]
## üü¢ Docker-compose STACK mode, starts with
# $ docker-compose config docker-compose.common.yml -f docker-compose.stack.yml > docker-stack.yml
# $ docker stack [deploy|rm] --with-registry-auth
# OR
# $ docker stack [deploy|rm] -c docker-stack.yml --with-registry-auth
###### 


# ü™ß Some information on this file : 
# See : https://docs.docker.com/compose/compose-file/compose-file-v3/

services:
  parcellaire-importer:
    # container_name is ignored on docker stack. 
    container_name: parcellaire-express-importer
    # build command is ignored on docker stack. 
    build:
      context: ./importer
    # image ref is ignored on docker compose. 
    image: ghcr.io/dnclain/parcellaire-importer:latest
    environment:
      - POSTGRES_USER
      - POSTGRES_PASSWORD
      - POSTGRES_DB
      - POSTGRES_HOST
      - POSTGRES_PORT
      - POSTGRES_SCHEMA
      - DOWNLOAD_URL
      - TEST_IMPORTER
      - MAX_PARALLEL_DL
    # volumes:
      #- importer-data:/tmp
      #- /data/parcellaire/importer:/tmp

  parcellaire-postgis:
    container_name: parcellaire-express-postgis
    # build command is ignored on docker stack. 
    build:
      context: ./postgis
      args:
        - POSTGRES_VERSION
        - POSTGIS_VERSION
    image: ghcr.io/dnclain/parcellaire-postgis:latest
    environment:
      - POSTGRES_DB
      - POSTGRES_PORT
      - POSTGRES_USER
      - POSTGRES_PASSWORD
    # Exposition du port de la base de donn√©es pour test si n√©cessaire
    #ports:
    #  - "${POSTGRES_PORT}:${POSTGRES_PORT}"    
    #volumes:
      #- parcellaire-postgis-data:/var/lib/postgresql/data
      #- /data/parcellaire/postgresql:/var/lib/postgresql/data
    # Options de configuration issues de PGTune (https://pgtune.leopard.in.ua)
    # Valeurs par d√©faut pour une instance Hetzner CPX21
    command:
      - "postgres"
      - "-c"
      - "max_connections=100"
      - "-c"
      - "shared_buffers=1GB"
      - "-c"
      - "effective_cache_size=3GB"
      - "-c"
      - "maintenance_work_mem=256MB"
      - "-c"
      - "checkpoint_completion_target=0.9"
      - "-c"
      - "wal_buffers=16MB"
      - "-c"
      - "default_statistics_target=100"
      - "-c"
      - "random_page_cost=1.1"
      - "-c"
      - "effective_io_concurrency=200"
      - "-c"
      - "work_mem=2621kB"
      - "-c"
      - "min_wal_size=1GB"
      - "-c"
      - "max_wal_size=4GB"
      - "-c"
      - "max_worker_processes=4"
      - "-c"
      - "max_parallel_workers_per_gather=2"
      - "-c"
      - "max_parallel_workers=4"
      - "-c"
      - "max_parallel_maintenance_workers=2"
      # Pour logguer l'int√©gralit√© des requ√™tes effectu√©es sur la base
      # - "-c"
      # - "log_statement=all"
    shm_size: 2g
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $POSTGRES_USER -d $POSTGRES_DB"]
      interval: 1m
      timeout: 5s
      retries: 5
      start_period: 10s

  # Frontal web pour exploration de la base si n√©cessaire
  # parcellaire-adminer:
  #     container_name: parcellaire-express-adminer
  #     image: adminer:4.8.1
  #     ports:
  #         - "8080:8080"
  #     environment:
  #        - ADMINER_DEFAULT_SERVER=${DB_HOST}
  #        - ADMINER_DESIGN=hydra

  parcellaire-api:
    container_name: parcellaire-express-api
    # build command is ignored on docker stack. 
    build:
      context: ./api
      args:
        - api_port=${API_PORT}
    image: ghcr.io/dnclain/parcellaire-api:latest
    environment:
      - POSTGRES_USER
      - POSTGRES_PASSWORD
      - POSTGRES_DB
      - POSTGRES_HOST
      - POSTGRES_PORT
      - POSTGRES_SCHEMA
      - API_PORT
      - API_KEY
      - MAX_FEATURE
      - VIEWER_URL
    ports:
      - "${API_PORT}:${API_PORT}"   
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "wget --no-verbose --tries=1 --spider http://localhost:${API_PORT}/status || exit 1",
        ]
      interval: 1m
      timeout: 5s
      retries: 5
      start_period: 10s


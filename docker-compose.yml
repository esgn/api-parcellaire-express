version: "3.8"

services:
  parcellaire-importer:
    container_name: parcellaire-express-importer
    build:
      context: ./importer
    environment:
      - POSTGRES_USER
      - POSTGRES_PASSWORD
      - POSTGRES_DB
      - POSTGRES_HOST
      - POSTGRES_PORT
      - POSTGRES_SCHEMA
      - DOWNLOAD_URL
      - TEST_IMPORTER
      - MAX_PARALLEL_DL
    volumes:
      - importer-data:/tmp

  parcellaire-postgis:
    container_name: parcellaire-express-postgis
    # Utilisation d'une image avec tuning automatique
    image: esgn/pgtuned:postgis-latest
    environment:
      - POSTGRES_DB
      - POSTGRES_PORT
      - POSTGRES_USER
      - POSTGRES_PASSWORD
      # Options pour tuning via esgn/pgtuned
      # - DB_TYPE=mixed
      - STGE_TYPE=ssd
      # - TOTAL_MEM=8GB
      # - CPU_COUNT=8
      # - MAX_CONN=1000
    # Exposition du port de la base de données pour test si nécessaire
    ports:
      - "${POSTGRES_PORT}:${POSTGRES_PORT}"
    volumes:
      - parcellaire-postgis-data:/var/lib/postgresql/data
    shm_size: 2g
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $POSTGRES_USER -d $POSTGRES_DB"]
      interval: 1m
      timeout: 5s
      retries: 5
      start_period: 10s

  # Frontal web pour exploration de la base si nécessaire
  # parcellaire-adminer:
  #     container_name: parcellaire-express-adminer
  #     image: adminer:4.8.1
  #     ports:
  #         - "8080:8080"
  #     environment:
  #        - ADMINER_DEFAULT_SERVER=${DB_HOST}
  #        - ADMINER_DESIGN=hydra

  parcellaire-api:
    container_name: parcellaire-express-api
    build:
      context: ./api
      args:
        - api_port=${API_PORT}
    environment:
      - POSTGRES_USER
      - POSTGRES_PASSWORD
      - POSTGRES_DB
      - POSTGRES_HOST
      - POSTGRES_PORT
      - POSTGRES_SCHEMA
      - API_PORT
      - MAX_FEATURE
      - VIEWER_URL
    ports:
      - "${API_PORT}:${API_PORT}"
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "wget --no-verbose --tries=1 --spider http://localhost:${API_PORT}/status || exit 1",
        ]
      interval: 1m
      timeout: 5s
      retries: 5
      start_period: 10s

volumes:
  parcellaire-postgis-data:
    name: parcellaire-postgis-data
  importer-data:
    name: importer-data
